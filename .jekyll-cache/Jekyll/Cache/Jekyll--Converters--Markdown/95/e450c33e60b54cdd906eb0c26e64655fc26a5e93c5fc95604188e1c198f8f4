I"ØG<p>functools æ¨¡å—åŒ…æ‹¬ï¼š</p>

<ul>
  <li>functools.cmp_to_key</li>
  <li>functools.reduce</li>
  <li>functools.total_ordering</li>
  <li>functools.partial</li>
  <li>functool.update_wrapper</li>
  <li>functool.wraps</li>
</ul>

<h2 id="functoolscmp_to_key">functools.cmp_to_key</h2>

<p>å°†è€å¼çš„ æ¯”è¾ƒå‡½æ•°ï¼ˆcomparison functionï¼‰ è½¬åŒ–ä¸º å…³é”®å­—å‡½æ•°ï¼ˆkey functionï¼‰ï¼Œæ˜¯ä¸ºäº†å…¼å®¹ Python3ã€‚</p>

<h2 id="functoolsreduce">functools.reduce</h2>
<p>å®˜æ–¹è§£é‡Šï¼š</p>

<p><em>This is the same function as reduce(). It is made available in this module to allow writing code more forward-compatible with Python 3.</em></p>

<p>å’Œå†…ç½®å‡½æ•° reduce åŠŸèƒ½ä¸€æ ·ï¼Œä¸ºäº†å…¼å®¹ Python3ã€‚</p>

<h2 id="functoolstotal_ordering">functools.total_ordering</h2>

<p>æ˜¯ä¸€ä¸ªç±»è£…é¥°å™¨ï¼Œä¸ºäº†æ–¹ä¾¿å®šä¹‰ç±»çš„æ¯”è¾ƒæ’åºæ–¹æ³•ï¼Œå¦‚æœæŸä¸ªç±»å®šä¹‰äº† <code class="highlighter-rouge">__lt__()</code>, <code class="highlighter-rouge">__le__()</code>, <code class="highlighter-rouge">__gt__()</code> æˆ– <code class="highlighter-rouge">__ge__()</code> ä¸­çš„è‡³å°‘ä¸€ä¸ªå¹¶ä¸”å®šä¹‰äº† <code class="highlighter-rouge">__eq__()</code> æ–¹æ³•ï¼Œé‚£ä¹ˆç”¨ functools.total_ordering è£…é¥°è¯¥ç±»ï¼Œè£…é¥°å™¨ä¼šè¡¥å……å…¶ä½™çš„æ¯”è¾ƒæ–¹æ³•ï¼Œè¿™å°±å‡å°‘äº†è‡ªå·±å®šä¹‰ä»£ç çš„å·¥ä½œé‡ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">@</span><span class="n">total_ordering</span>
<span class="k">class</span> <span class="nc">Person</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

</code></pre></div></div>

<h2 id="functoolspartial">functools.partial</h2>

<p>å‡½æ•°å‚æ•°åˆ†ä½ç½®å‚æ•°å’Œå…³é”®å­—å‚æ•°ä¸¤ç§ï¼Œè€Œ partial çš„ä½œç”¨å°±æ˜¯å†»ç»“å‡½æ•°çš„éƒ¨åˆ†å‚æ•°ï¼ˆå¯ä»¥ä½¿ä½ç½®å‚æ•°å’Œå…³é”®å­—å‡½æ•°ï¼‰ï¼Œä»è€Œè¾¾åˆ°â€œé‡æ–°å®šä¹‰â€å‡½æ•°çš„ç­¾åï¼Œè¿™æ ·å¯ä»¥åœ¨æŸäº›æƒ…å†µä¸‹ç®€åŒ–å‡½æ•°è°ƒç”¨ï¼Œä¸¾ä¾‹è¯´æ˜ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># å®šä¹‰å‡½æ•° addï¼Œå®ç°ä¸‰ä¸ªæ•°ç›¸åŠ 
</span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s">"""this is a test method"""</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>

</code></pre></div></div>

<p>æƒ³è±¡å¦‚ä¸‹åœºæ™¯ï¼šæˆ‘ä»¬éœ€è¦å¤šæ¬¡è°ƒç”¨ add å‡½æ•°ï¼Œè°ƒç”¨æ—¶ z çš„å€¼éƒ½æ˜¯ 3ï¼Œé‚£ä¹ˆå¯ä»¥è¿™ä¹ˆå†™ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">add</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="o">...</span>

</code></pre></div></div>

<p>å› ä¸ºè°ƒç”¨æ—¶ï¼Œå…³é”®å­—å‚æ•° z æ°¸è¿œç­‰äº 3ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥ç®€åŒ–ä¸å†™å—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä¸‹é¢å°±ç”¨åˆ°äº† functools.partial äº†ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="n">add_</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># é‚£ä¹ˆï¼Œè°ƒç”¨å°±å¯ä»¥å†™ä¸ºï¼š
</span><span class="n">add_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">add_</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">add_</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">add_</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="o">...</span>

</code></pre></div></div>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š
æ­¤æ—¶ï¼Œä»å¯ä»¥ç»™ add_ ä¼ é€’ç¬¬ä¸‰ä¸ªå‚æ•° zï¼Œä½†å¿…é¡»è¿™ä¹ˆå†™</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">add_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>
<p>å¦‚æœä¸æŒ‡å®šå…³é”®å­—ï¼Œåˆ™ä¼šæŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š</p>

<pre><code class="language-Python">
TypeError: add() got multiple values for keyword argument 'z'

</code></pre>

<p>åŒæ ·ç”¨æ³•å¯ä»¥ç”¨åœ¨ä½ç½®å‚æ•°ä¸Šï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œpartial æä¾›çš„å‚æ•°åœ¨åŸå‡½æ•°çš„ä½ç½®å…³é”®å­—å‰ï¼Œçœ‹ partial çš„å®ç°å°±å¯ä»¥ç†è§£ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Purely functional, no descriptor behaviour
</span><span class="k">def</span> <span class="nf">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
    <span class="s">"""New function with partial application of the given arguments
    and keywords.
    """</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">'func'</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">args</span> <span class="o">+</span> <span class="n">args</span>
        <span class="n">tmpkw</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tmpkw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">tmpkw</span>
        <span class="k">del</span> <span class="n">tmpkw</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">func</span>

    <span class="k">def</span> <span class="nf">newfunc</span><span class="p">(</span><span class="o">*</span><span class="n">fargs</span><span class="p">,</span> <span class="o">**</span><span class="n">fkeywords</span><span class="p">):</span>
        <span class="n">newkeywords</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newkeywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fkeywords</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="n">fargs</span><span class="p">),</span> <span class="o">**</span><span class="n">newkeywords</span><span class="p">)</span>
    <span class="n">newfunc</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
    <span class="n">newfunc</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">newfunc</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">keywords</span>
    <span class="k">return</span> <span class="n">newfunc</span>

</code></pre></div></div>

<h2 id="functoolsupdate_wrapper">functools.update_wrapper</h2>

<p>åœ¨ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œå‡½æ•° add æ˜¯æœ‰æ³¨é‡Šçš„ï¼ˆä¸€èˆ¬å†™æ˜å‡½æ•°çš„è°ƒç”¨æ–¹æ³•ç­‰ç­‰ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå·±çš„ add_ å‘¢ï¼Ÿçœ‹ä¸‹é¢ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">print</span> <span class="n">add</span><span class="o">.</span><span class="n">__doc__</span>
<span class="k">print</span> <span class="n">add_</span><span class="o">.</span><span class="n">__doc__</span>

<span class="c1"># è¾“å‡ºï¼š
</span><span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">test</span> <span class="n">method</span> 
<span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">)</span> <span class="o">-</span> <span class="n">new</span> <span class="n">function</span> <span class="k">with</span> <span class="n">partial</span> <span class="n">application</span>
    <span class="n">of</span> <span class="n">the</span> <span class="n">given</span> <span class="n">arguments</span> <span class="ow">and</span> <span class="n">keywords</span><span class="o">.</span>

</code></pre></div></div>

<p>æ‰€ä»¥ï¼Œè¿™æ—¶å‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå‡å¦‚æœ‰äººæƒ³ç”¨æˆ‘ä»¬çš„ add_ å‡½æ•°ï¼Œä½†æ˜¯æƒ³çœ‹ä¸€ä¸‹ doc ï¼Œå‘ç°æ˜¯æ²¡æœ‰çš„ï¼Œé‚£ä¹ˆ update_wrapper å°±æä¾›äº†è§£å†³åŠæ³•ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">update_wrapper</span><span class="p">(</span><span class="n">add_</span><span class="p">,</span> <span class="n">add</span><span class="p">)</span>
<span class="k">print</span> <span class="n">add_</span><span class="o">.</span><span class="n">__doc__</span>

<span class="c1"># è¾“å‡ºï¼š
</span>

 <span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">test</span> <span class="n">method</span> 

</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒåŸæœ¬å±äº add çš„ doc ï¼Œadd_ ä¹Ÿæœ‰äº†ï¼Œè¿™æ ·åœ¨ debug çš„æ—¶å€™å°±å¾ˆæ–¹ä¾¿äº†ã€‚è¿™å°±æ˜¯ <code class="highlighter-rouge">update_wrapper</code> çš„åŠŸèƒ½ï¼Œå®ƒå¯ä»¥æŠŠè¢«å°è£…å‡½æ•°çš„ <code class="highlighter-rouge">__name__</code>ã€<code class="highlighter-rouge">__module__</code>ã€<code class="highlighter-rouge">__doc__</code> å’Œ  <code class="highlighter-rouge">__dict__</code> éƒ½å¤åˆ¶åˆ°å°è£…å‡½æ•°å»ï¼ˆæ¨¡å—çº§åˆ«å¸¸é‡WRAPPER_ASSIGNMENTS, WRAPPER_UPDATESï¼‰ã€‚</p>

<p>æºç å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">WRAPPER_ASSIGNMENTS</span> <span class="o">=</span> <span class="p">(</span><span class="s">'__module__'</span><span class="p">,</span> <span class="s">'__name__'</span><span class="p">,</span> <span class="s">'__doc__'</span><span class="p">)</span>
<span class="n">WRAPPER_UPDATES</span> <span class="o">=</span> <span class="p">(</span><span class="s">'__dict__'</span><span class="p">,)</span>
<span class="k">def</span> <span class="nf">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span>
                   <span class="n">wrapped</span><span class="p">,</span>
                   <span class="n">assigned</span> <span class="o">=</span> <span class="n">WRAPPER_ASSIGNMENTS</span><span class="p">,</span>
                   <span class="n">updated</span> <span class="o">=</span> <span class="n">WRAPPER_UPDATES</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">assigned</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">updated</span><span class="p">:</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">{}))</span>
    <span class="k">return</span> <span class="n">wrapper</span>
    
</code></pre></div></div>

<p>è¿™ä¸ªåŠŸèƒ½åœ¨å®šä¹‰è£…é¥°å™¨çš„æ—¶å€™åº”è¯¥æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p>

<h2 id="functoolswraps">functools.wraps</h2>

<p>functools.wraps å°±æ˜¯ç”¨ partial å¯¹ update_wrapper åšäº†åŒ…è£…ï¼Œçœ‹å®ç°ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">wraps</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span>
          <span class="n">assigned</span> <span class="o">=</span> <span class="n">WRAPPER_ASSIGNMENTS</span><span class="p">,</span>
          <span class="n">updated</span> <span class="o">=</span> <span class="n">WRAPPER_UPDATES</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">update_wrapper</span><span class="p">,</span> <span class="n">wrapped</span><span class="o">=</span><span class="n">wrapped</span><span class="p">,</span>
                   <span class="n">assigned</span><span class="o">=</span><span class="n">assigned</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="n">updated</span><span class="p">)</span>

</code></pre></div></div>

<p>ä½¿ç”¨åœºæ™¯ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="k">def</span> <span class="nf">my_decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
     <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
     <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
         <span class="k">print</span> <span class="s">'Calling decorated function'</span>
         <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">wrapper</span>

<span class="o">@</span><span class="n">my_decorator</span>
<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="s">"""è¿™é‡Œæ˜¯æ–‡æ¡£æ³¨é‡Š"""</span>
    <span class="k">print</span> <span class="s">'Called example function'</span>

<span class="n">example</span><span class="p">()</span>

<span class="c1"># ä¸‹é¢æ˜¯è¾“å‡º
</span><span class="s">"""
Calling decorated function
Called example function
"""</span>
<span class="k">print</span> <span class="n">example</span><span class="o">.</span><span class="n">__name__</span> <span class="c1"># 'example'
</span><span class="k">print</span> <span class="n">example</span><span class="o">.</span><span class="n">__doc__</span> <span class="c1"># 'è¿™é‡Œæ˜¯æ–‡æ¡£æ³¨é‡Š'
</span>
</code></pre></div></div>
:ET